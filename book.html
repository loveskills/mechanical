<!DOCTYPE html>
<html lang="km" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFIED: Updated page title -->
    <title data-translate-key="page_title">ឯកសារមេរៀន - វិស្វកម្មមេកានិក</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class', // Enable class-based dark mode
        theme: {
          extend: {}
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Base font */
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Specify fonts for different languages */
        :lang(en) body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        /* Animation for page content */
        .page-content {
            display: block; /* Make content visible by default */
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Active nav link style */
        .nav-link.active {
            color: #2563EB; /* blue-600 */
            font-weight: 600;
            border-bottom: 2px solid #2563EB;
        }
        /* Dark mode active nav link style */
        .dark .nav-link.active {
            color: #60A5FA; /* blue-400 */
            border-bottom-color: #60A5FA;
        }
        /* SVG Logo continuous rotation animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .logo-gear {
            animation: spin 10s linear infinite;
        }
        /* Custom style for date picker calendar icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
             filter: invert(0.8);
        }
        /* Ensure hidden books take up no space */
        .book-item:not(.flex) {
            display: none !important;
        }
        /* NEW: Modal Filter Button Styles */
        .modal-filter-btn {
            border: 1px solid #D1D5DB; /* gray-300 */
            background-color: #FFFFFF; /* white */
            color: #374151; /* gray-700 */
        }
        .dark .modal-filter-btn {
            border-color: #4B5563; /* gray-600 */
            background-color: #374151; /* gray-700 */
            color: #D1D5DB; /* gray-300 */
        }
        .modal-filter-btn.active {
            background-color: #2563EB; /* blue-600 */
            color: #FFFFFF; /* white */
            border-color: #2563EB; /* blue-600 */
        }
        .dark .modal-filter-btn.active {
            background-color: #3B82F6; /* blue-500 */
            border-color: #3B82F6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- MODIFIED: Link back to index.html -->
            <a href="index.html#home" class="flex items-center space-x-3 text-blue-600 dark:text-blue-400">
                <svg class="logo-gear h-9 w-9 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M19.1255 7.96289L19.3755 7.71289C19.8635 7.22489 20.6275 7.22489 21.1155 7.71289L21.2875 7.88489C21.7755 8.37289 21.7755 9.13689 21.2875 9.62489L21.0375 9.87489" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M4.87451 16.0371L4.62451 16.2871C4.13651 16.7751 3.37251 16.7751 2.88451 16.2871L2.71251 16.1151C2.22451 15.6271 2.22451 14.8631 2.71251 14.3751L2.96251 14.1251" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M7.96289 4.87451L7.71289 4.62451C7.22489 4.13651 7.22489 3.37251 7.71289 2.88451L7.88489 2.71251C8.37289 2.22451 9.13689 2.22451 9.62489 2.71251L9.87489 2.96251" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16.0371 19.1255L16.2871 19.3755C16.7751 19.8635 16.7751 20.6275 16.2871 21.1155L16.1151 21.2875C15.6271 21.7755 14.8631 21.7755 14.3751 21.2875L14.1251 21.0375" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M22 12H19" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M5 12H2" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 5V2" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 22V19" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="text-2xl font-bold" data-translate-key="brand_name">វិស្វករមេកានិក</span>
            </a>
            
            <!-- START: Desktop Navigation Update -->
            <div class="hidden md:flex items-center space-x-8">
                <!-- MODIFIED: Links point back to index.html sections -->
                <a href="index.html#home" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center">
                    <i class="fas fa-home fa-fw mr-2"></i><span data-translate-key="nav_home">ទំព័រដើម</span>
                </a>
                <a href="index.html#specializations" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center">
                    <i class="fas fa-cogs fa-fw mr-2"></i><span data-translate-key="nav_specializations">ឯកទេស</span>
                </a>
                <a href="index.html#education" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center">
                    <i class="fas fa-graduation-cap fa-fw mr-2"></i><span data-translate-key="nav_education">កម្រិតសិក្សា</span>
                </a>
                <!-- MODIFIED: "Book" link is now active -->
                <a href="book.html" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center active">
                    <i class="fas fa-book fa-fw mr-2"></i><span data-translate-key="nav_book">សៀវភៅ</span>
                </a>
                <!-- UPDATED: Changed href to gallery.html -->
                <a href="gallery.html" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center">
                    <i class="fas fa-images fa-fw mr-2"></i><span data-translate-key="nav_gallery">កម្រងរូបភាព</span>
                </a>
                <a href="register.html" class="nav-link text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 transition duration-300 pb-1 inline-flex items-center">
                    <i class="fas fa-file-alt fa-fw mr-2"></i><span data-translate-key="nav_register">បំពេញពាក្យស្នើសុំ</span>
                </a>
            </div>
            <!-- END: Desktop Navigation Update -->

            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="flex p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" aria-label="Toggle dark mode">
                    <i id="theme-icon" class="fas fa-sun fa-lg"></i>
                </button>
                <div class="relative hidden md:block" id="lang-switcher-container">
                    <button id="lang-switcher-btn" class="flex items-center p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                        <img id="current-lang-flag" src="https://flagcdn.com/kh.svg" alt="Language" class="w-8 h-5 rounded-sm border border-gray-200">
                        <i class="fas fa-chevron-down w-4 h-4 ml-2 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div id="lang-options" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-50">
                        <a href="#" onclick="setLanguage('km')" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <img src="https://flagcdn.com/kh.svg" class="w-6 h-4 mr-3 rounded-sm"> <span data-translate-key="lang_km">ភាសាខ្មែរ</span>
                        </a>
                        <a href="#" onclick="setLanguage('en')" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <img src="https://flagcdn.com/gb.svg" class="w-6 h-4 mr-3 rounded-sm"> <span data-translate-key="lang_en">English</span>
                        </a>
                    </div>
                </div>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-600 dark:text-gray-300 focus:outline-none">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- START: Mobile Navigation Update -->
        <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-800 shadow-lg">
            <a href="index.html#home" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <i class="fas fa-home fa-fw mr-3"></i><span data-translate-key="nav_home">ទំព័រដើម</span>
            </a>
            <a href="index.html#specializations" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <i class="fas fa-cogs fa-fw mr-3"></i><span data-translate-key="nav_specializations">ឯកទេស</span>
            </a>
            <a href="index.html#education" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <i class="fas fa-graduation-cap fa-fw mr-3"></i><span data-translate-key="nav_education">កម្រិតសិក្សា</span>
            </a>
            <!-- MODIFIED: "Book" link is active -->
            <a href="book.html" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center active">
                <i class="fas fa-book fa-fw mr-3"></i><span data-translate-key="nav_book">សៀវភៅ</span>
            </a>
            <!-- UPDATED: Changed href to gallery.html -->
            <a href="gallery.html" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <i class="fas fa-images fa-fw mr-3"></i><span data-translate-key="nav_gallery">កម្រងរូបភាព</span>
            </a>
            <a href="register.html" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <i class="fas fa-file-alt fa-fw mr-3"></i><span data-translate-key="nav_register">បំពេញពាក្យស្នើសុំ</span>
            </a>
            
            <a href="#" onclick="setLanguage('km')" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <img src="https://flagcdn.com/kh.svg" class="w-6 h-4 mr-3 rounded-sm"> <span data-translate-key="lang_km">ភាសាខ្មែរ</span>
            </a>
            <a href="#" onclick="setLanguage('en')" class="block px-6 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center">
                <img src="https://flagcdn.com/gb.svg" class="w-6 h-4 mr-3 rounded-sm"> <span data-translate-key="lang_en">English</span>
            </a>
        </div>
        <!-- END: Mobile Navigation Update -->
    </header>

    <main class="container mx-auto px-6 py-12">
        <!-- Book Library Section -->
        <section id="book-library" class="page-content py-1">
            <div class="text-center mb-12">
                <!-- NEW: Logo Image -->
                <img src="photo/1.png" alt="Logo for Lesson Library" class="w-24 h-24 mx-auto mb-4 object-contain" onerror="this.onerror=null; this.src='https://placehold.co/64x64/2563EB/FFFFFF?text=Logo'">
                
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100" data-translate-key="book_title">ឯកសារមេរៀន</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-4 max-w-3xl mx-auto" data-translate-key="book_subtitle">ស្វែងរក និងទាញយកឯកសារមេរៀន PDF សម្រាប់ជំនាញវិស្វកម្មមេកានិក។</p>
            </div>

            <!-- MODIFIED: Filter Dropdown and Search Bar -->
            <div id="filter-search-container" class="mb-8 flex flex-col md:flex-row items-center gap-4 md:gap-6">
                <!-- Level Filter Dropdown -->
                <!-- UPDATED: md:w-auto changed to md:w-60 for better desktop control -->
                <div class="relative w-full md:w-60"> 
                    
                    <!-- ADDED: Icon inside -->
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-layer-group text-gray-400"></i>
                    </div>
                    
                    <!-- ADDED: pl-10 for padding, removed redundant md:w-52 -->
                    <!-- MODIFICATION: Reordered filter options -->
                    <select id="level-filter" onchange="applyFilters()" class="block w-full appearance-none rounded-md border border-gray-300 dark:border-gray-600 px-3 py-2 pl-10 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm">
                        <option value="all" data-translate-key="level_all">ទាំងអស់</option>
                        <option value="c1" data-translate-key="level_c1">C1</option>
                        <option value="c2" data-translate-key="level_c2">C2</option>
                        <option value="c3" data-translate-key="level_c3">C3</option>
                        <option value="associate" data-translate-key="level_associate">បរិញ្ញាបត្ររង</option>
                        <option value="bachelor" data-translate-key="level_bachelor">បរិញ្ញាបត្រ</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400">
                        <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <!-- Search Input -->
                <div class="relative flex-grow w-full">
                    
                     <!-- ADDED: Icon inside (left) -->
                     <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>

                    <!-- ADDED: pl-10 for padding -->
                    <!-- UPDATED: data-translate-key="search_placeholder" value in translations object changed -->
                    <input type="search" id="search-input" oninput="applyFilters()" placeholder="ស្វែងរកមេរៀន..." data-translate-key="search_placeholder" class="block w-full appearance-none rounded-md border border-gray-300 dark:border-gray-600 px-3 py-2 pl-10 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm">
                    
                </div>
            </div>
            
            <!-- MODIFIED: Added id="book-grid" and class="book-item" -->
            <!-- EDITED: Changed lg:grid-cols-3 to lg:grid-cols-4 -->
            <!-- MODIFICATION: Reordered book items -->
            <div id="book-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                
                <!-- Book 2 - C1 -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="c1">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/Book cover/1.jpg" alt="Lesson 2 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book2_title">មេរៀនកម្រិត១ (C1)</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book2_desc">មេរៀនសម្រាប់កម្រិត C1 រួមមានម៉ូឌុលចំនួន ៤ នៃសមត្ថភាពស្នូល។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book2')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 8 - C2 -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="c2">
                    <img src="photo/Book cover/2.jpg" alt="Lesson C2 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book8_title">មេរៀនកម្រិត២ (C2)</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book8_desc">មេរៀនសម្រាប់កម្រិត C2។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                         <button onclick="openModal('book8')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 9 - C3 -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="c3">
                    <img src="photo/Book cover/3.jpg" alt="Lesson C3 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book9_title">មេរៀនកម្រិត៣ (C3)</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book9_desc">មេរៀនសម្រាប់កម្រិត C3។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                         <button onclick="openModal('book9')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 1 - Associate -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="associate">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/TB1-2 Core Capability.jpg" alt="Core Capability Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book1_title">សមត្ថភាពស្នូល</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book1_desc">ឯកសារណែនាំអំពីគោលការណ៍គ្រឹះនៃវិស្វកម្មមេកានិក ស្ថានភាពលំនឹង និងកម្លាំង។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book1')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Book 7 - Associate -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="associate">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/TB1-2 Basic Competency.jpg" alt="Basic Competency Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book7_title">សមត្ថភាពមូលដ្ឋាន</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book7_desc">មុខវិជ្ជាស្នូលសម្រាប់កម្រិតបរិញ្ញាបត្ររងផ្តោតលើជំនាញមូលដ្ឋានគ្រឹះនៃមេកានិក។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book7')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 3 - Bachelor -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="bachelor">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/Book cover/Solid.jpg" alt="Lesson 3 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book3_title">ការរចនា 3D (SolidWorks)</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book3_desc">ស្វែងយល់ពីការបង្កើតគំរូ 3D ការផ្គុំគ្រឿង និងការវិភាគស្ត្រេស (Stress Analysis) ជាមួយ SolidWorks។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book3')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 4 - Bachelor -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="bachelor">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/Book cover/CN.jpg" alt="Lesson 4 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book4_title">បច្ចេកវិទ្យា CNC</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book4_desc">មេរៀនអំពីការសរសេរ G-Code, M-Code និងការបញ្ជាម៉ាស៊ីនក្រឡឹង និងហ្វ្រេស CNC។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book4')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Book 5 - Bachelor -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="bachelor">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/Book cover/HP.jpg" alt="Lesson 5 Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book5_title">ប្រព័ន្ធប្រេង និងខ្យល់</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book5_desc">សិក្សាអំពីសមាសធាតុ និងការរចនាប្រព័ន្ធបញ្ជាដោយ Hydraulics និង Pneumatics។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                        <button onclick="openModal('book5')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Book 6 - Bachelor -->
                <div class="book-item bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden group flex flex-col" data-level="bachelor">
                    <!-- EDITED: Changed h-96 to h-[30rem] -->
                    <img src="photo/Book cover/A.jpg" alt="Arduino Systems Cover" class="w-full h-[30rem] object-cover">
                    <div class="p-6 flex-grow">
                        <h3 class="book-title text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2" data-translate-key="book6_title">ប្រព័ន្ធ Arduino (Arduino systems)</h3>
                        <p class="book-desc text-sm text-gray-600 dark:text-gray-400" data-translate-key="book6_desc">មេរៀនអំពីការសរសេរកូដ និងបញ្ជាគ្រឿងអេឡិចត្រូនិក។</p>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-gray-700">
                         <button onclick="openModal('book6')" class="w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center group">
                            <span data-translate-key="book_view_btn">មើលមេរៀន</span> <i class="fas fa-eye ml-2"></i>
                        </button>
                    </div>
                </div>

                 <!-- NEW: Message when no books match -->
                 <div id="no-results-message" class="hidden col-span-full text-center text-gray-500 dark:text-gray-400 py-8">
                     <i class="fas fa-search fa-2x mb-3"></i>
                     <p data-translate-key="no_results">រកមិនឃើញមេរៀនដែលត្រូវនឹងតម្រងរបស់អ្នកទេ។</p>
                 </div>

            </div>
            
            <!-- NEW: Button to Gallery -->
             <div class="mt-16 text-center">
                <a href="gallery.html" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition duration-300 text-lg shadow-lg inline-flex items-center group">
                    <i class="fas fa-images mr-3"></i> <span data-translate-key="nav_gallery">កម្រងរូបភាព</span>
                </a>
            </div>
            
        </section>
        <!-- END: Book Library Section -->
    </main>

    <section class="container mx-auto px-6 py-10">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100" data-translate-key="contact_title">ទំនាក់ទំនងមកពួកយើង</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-4 max-w-3xl mx-auto" data-translate-key="contact_subtitle">យើងរីករាយនឹងឆ្លើយតបរាល់សំណួររបស់អ្នក។ សូមទំនាក់ទំនងតាមរយៈបណ្តាញខាងក្រោម៖</p>
        </div>
        <div class="grid md:grid-cols-2 gap-10 items-start">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full flex flex-col items-center justify-center">
                <div class="flex space-x-4 md:space-x-6">
                    <a href="https://web.facebook.com/profile.php?id=100075802995392" target="_blank" class="w-12 h-12 md:w-16 md:h-16 bg-blue-600 rounded-full flex items-center justify-center text-white hover:opacity-90 transform hover:scale-105 transition-all duration-300" aria-label="Facebook">
                        <i class="fab fa-facebook-f fa-lg md:fa-2x"></i>
                    </a>
                    <a href="https://t.me/chorkratana" target="_blank" class="w-12 h-12 md:w-16 md:h-16 bg-sky-500 rounded-full flex items-center justify-center text-white hover:opacity-90 transform hover:scale-105 transition-all duration-300" aria-label="Telegram">
                        <i class="fab fa-telegram-plane fa-lg md:fa-2x"></i>
                    </a>
                    <a href="tel:+85512521375" class="w-12 h-12 md:w-16 md:h-16 bg-green-500 rounded-full flex items-center justify-center text-white hover:opacity-90 transform hover:scale-105 transition-all duration-300" aria-label="Phone">
                        <i class="fas fa-phone fa-lg md:fa-2x"></i>
                    </a>
                    <a href="mailto:ratana.lyon2uni@gmail.com" class="w-12 h-12 md:w-16 md:h-16 bg-red-500 rounded-full flex items-center justify-center text-white hover:opacity-90 transform hover:scale-105 transition-all duration-300" aria-label="Email">
                        <i class="fas fa-envelope fa-lg md:fa-2x"></i>
                    </a>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full">
                <h3 class="font-bold text-xl mb-4 text-gray-900 dark:text-gray-100" data-translate-key="contact_form_title">ផ្ញើសារ</h3>
                
                <button id="showContactFormBtn" onclick="toggleContactForm()" type="button" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-3 px-4 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 font-bold transition text-lg inline-flex items-center justify-center" data-translate-key="contact_show_form_btn">
                    <i class="fas fa-pencil-alt mr-2"></i>
                    ចុចទីនេះដើម្បីផ្ញើសារ
                </button>

                <form id="contactForm" class="space-y-6 hidden" onsubmit="event.preventDefault(); sendEmail();">
                    <div>
                        <label for="contactName" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-translate-key="contact_form_name">ឈ្មោះ</label>
                        <div class="relative mt-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <input type="text" id="contactName" class="block w-full pl-10 pr-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100" required>
                        </div>
                    </div>
                    <div>
                        <label for="contactEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-translate-key="contact_form_email">អ៊ីមែល</label>
                        <div class="relative mt-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-gray-400"></i>
                            </div>
                            <input type="email" id="contactEmail" class="block w-full pl-10 pr-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100" required>
                        </div>
                    </div>
                    <div>
                        <label for="contactMessage" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-translate-key="contact_form_message">សារ</label>
                         <div class="relative mt-1">
                             <div class="absolute top-0 left-0 pl-3 pt-3 flex items-center pointer-events-none">
                                <i class="fas fa-pencil-alt text-gray-400"></i>
                            </div>
                            <textarea id="contactMessage" rows="4" class="block w-full pl-10 pr-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100" required></textarea>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" onclick="closeContactForm()" class="w-full bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-3 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold transition text-base" data-translate-key="contact_form_cancel">
                            បោះបង់
                        </button>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 font-bold transition text-base inline-flex items-center justify-center" data-translate-key="contact_form_submit">
                            <i class="fas fa-paper-plane mr-2"></i>
                            ផ្ញើសារ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 dark:bg-gray-950 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-gray-400" data-translate-key="footer_text">ចាប់ផ្តើមដំណើររបស់អ្នកក្នុងវិស័យវិស្វកម្មមេកានិកនៅថ្ងៃនេះ ហើយរួមចំណែកបង្កើតបច្ចេកវិទ្យាថ្មីៗ។</p>
            <div class="mt-4">
                <p class="text-gray-500 text-sm" data-translate-key="footer_copyright">រក្សាសិទ្ធិគ្រប់យ៉ាង © 2025 | បង្កើតដោយ ខៀវ សំណាង</p>
            </div>
        </div>
    </footer>

    <!-- Modal Structure -->
    <div id="pdfModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-75 hidden" onclick="closeModal()">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-3 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-3xl font-light">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100"></h3>
            
            <!-- NEW: Modal Filter Bar -->
            <div id="modalFilterBar" class="hidden flex items-center justify-center space-x-2 mb-4">
                <button id="modal-filter-lessons"
                        class="modal-filter-btn px-4 py-2 rounded-md text-sm font-medium transition duration-150"
                        data-translate-key="filter_lessons">
                    មេរៀន
                </button>
                <button id="modal-filter-exercises"
                        class="modal-filter-btn px-4 py-2 rounded-md text-sm font-medium transition duration-150"
                        data-translate-key="filter_exercises">
                    លំហាត់
                </button>
            </div>

            <div id="modalLinks" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Links will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Translations object
        const translations = {
            km: {
                page_title: "ឯកសារមេរៀន - វិស្វកម្មមេកានិក",
                brand_name: "វិស្វករមេកានិក",
                nav_home: "ទំព័រដើម",
                nav_specializations: "ឯកទេស",
                nav_education: "កម្រិតសិក្សា",
                nav_book: "សៀវភៅ",
                nav_register: "បំពេញពាក្យស្នើសុំ",
                nav_gallery: "កម្រងរូបភាព",
                nav_theme_toggle: "ប្តូរពន្លឺ",
                lang_km: "ភាសាខ្មែរ",
                lang_en: "English",
                book_title: "ឯកសារមេរៀន",
                book_subtitle: "ស្វែងរក និងទាញយកឯកសារមេរៀន PDF សម្រាប់ជំនាញវិស្វកម្មមេកានិក។",
                // MODIFIED: Renamed "មូលដ្ឋានគ្រឹះមេកានិក" to "សមត្ថភាពស្នូល"
                book1_title: "សមត្ថភាពស្នូល",
                book1_desc: "ឯកសារណែនាំអំពីគោលការណ៍គ្រឹះនៃវិស្វកម្មមេកានិក ស្ថានភាពលំនឹង និងកម្លាំង។",
                // MODIFICATION: Changed book 2 title and desc
                book2_title: "មេរៀនកម្រិត១ (C1)",
                book2_desc: "មេរៀនសម្រាប់កម្រិត C1 រួមមានម៉ូឌុលចំនួន ៤ នៃសមត្ថភាពស្នូល។",
                book3_title: "ការរចនា 3D (SolidWorks)",
                book3_desc: "ស្វែងយល់ពីការបង្កើតគំរូ 3D ការផ្គុំគ្រឿង និងការវិភាគស្ត្រេស (Stress Analysis) ជាមួយ SolidWorks។",
                book4_title: "បច្ចេកវិទ្យា CNC",
                book4_desc: "មេរៀនអំពីការសរសេរ G-Code, M-Code និងការបញ្ជាម៉ាស៊ីនក្រឡឹង និងហ្វ្រេស CNC។",
                book5_title: "ប្រព័ន្ធប្រេង និងខ្យល់",
                book5_desc: "សិក្សាអំពីសមាសធាតុ និងការរចនាប្រព័ន្ធបញ្ជាដោយ Hydraulics និង Pneumatics។",
                book6_title: "ប្រព័ន្ធ Arduino (Arduino systems)",
                book6_desc: "មេរៀនអំពីការសរសេរកូដ និងបញ្ជាគ្រឿងអេឡិចត្រូនិក។",
                // NEW: Added Basic Competency Book (Book 7)
                book7_title: "សមត្ថភាពមូលដ្ឋាន",
                book7_desc: "មុខវិជ្ជាស្នូលសម្រាប់កម្រិតបរិញ្ញាបត្ររងផ្តោតលើជំនាញមូលដ្ឋានគ្រឹះនៃមេកានិក។",
                // NEW: Added Book 8 and 9
                book8_title: "មេរៀនកម្រិត២ (C2)",
                book8_desc: "មេរៀនសម្រាប់កម្រិត C2។",
                book9_title: "មេរៀនកម្រិត៣ (C3)",
                book9_desc: "មេរៀនសម្រាប់កម្រិត C3។",
                book_view_btn: "មើលមេរៀន",
                book_read_btn: "អាន",
                book_download_btn: "ទាញយក",
                // MODIFIED: Added Module translations (1-11)
                module_1: "ម៉ូឌុលទី១",
                module_2: "ម៉ូឌុលទី២",
                module_3: "ម៉ូឌុលទី៣",
                module_4: "ម៉ូឌុលទី៤",
                module_5: "ម៉ូឌុលទី៥",
                module_6: "ម៉ូឌុលទី៦",
                module_7: "ម៉ូឌុលទី៧",
                module_8: "ម៉ូឌុលទី៨",
                module_9: "ម៉ូឌុលទី៩",
                module_10: "ម៉ូឌុលទី១០",
                module_11: "ម៉ូឌុលទី១១",
                
                // NEW C1, C2, C3 MODULES (Corrected Comment Syntax)
                c1_mod_1: "មុខវិជ្ជា ប្រមុំ",
                c1_mod_2: "មុខវិជ្ជា ជំនាញទន់",
                c1_mod_3: "មុខវិជ្ជា ការបន្សីលោហៈ កម្រិត១",
                c1_mod_4: "មុខវិជ្ជា ការបន្ស៉ីលោហៈ កម្រិត២",
                c2_mod_1: "មុខវិជ្ជា ការបន្ស៉ីលោហៈ កម្រិត៣",
                c3_mod_1: "មុខវិជ្ជា ការបន្ស៉ីលោហៈ កម្រិត៤",

                // NEW: CNC (Book 4) Modules
                book4_mod_1: "CNC_Training Notes",
                book4_mod_2: "Commissioning_Guide",
                book4_mod_3: "Operating_and_Programming_Milling",
                book4_mod_4: "Operating_and_Programming_Turning",

                // NEW: Arduino (Book 6) Modules
                book6_mod_1: "Microcontroller_Programming",
                book6_mod_2: "Motors_Control_SyStemS_Electric",
                book6_mod_3: "Programmable_Logic_Controllers",
                book6_mod_4: "PCB-design-cource-I",
                book6_mod_5: "PCB-design-cource-II",

                // NEW: Hydraulics (Book 5) Modules
                book5_mod_1: "មូលដ្ឋានគ្រឹះ_ប្រពន្ធ័ហាយដ្រូលិក",
                book5_mod_2: "និសញ្ញាគ្រឿងបង្គំប្រពន្ធ័ខ្យល់",
                book5_mod_3: "សេម៉ាប្រពន្ធ័ខ្យល់",
                book5_mod_4: "Basic Hydraulics",
                book5_mod_5: "Basic Pneumatic System",
                book5_mod_6: "Basic_Electrohydraulic_Symbols",
                book5_mod_7: "Electrical Pneumatic System Circuit",
                book5_mod_8: "Fluid-Power-Formulas",
                book5_mod_9: "Hydraulic System CBLM",
                book5_mod_10: "Pneumatic System",
                book5_mod_11: "POR Pneumatic Valves",
                book5_mod_12: "Pneumatic-Hydraulic for ETEK",
                book5_mod_13: "Pneumatic-Hydraulic Practice",
                book5_mod_14: "Practical Hydraulics system",
                book5_mod_15: "Symbol use in Hydraulic",

                // NEW: SolidWorks (Book 3) Modules
                book3_lessons_title: "មេរៀន",
                book3_exercises_title: "លំហាត់អនុវត្តន៌",
                book3_l1: "មេរៀនទី១", book3_l2: "មេរៀនទី២", book3_l3: "មេរៀនទី៣",
                book3_l4: "មេរៀនទី៤", book3_l5: "មេរៀនទី៥", book3_l6: "មេរៀនទី៦",
                book3_l7: "មេរៀនទី៧", book3_l8: "មេរៀនទី៨", book3_l9: "មេរៀនទី៩",
                book3_l10: "មេរៀនទី១០", book3_l11: "មេរៀនទី១១", book3_l12: "មេរៀនទី១២",
                book3_l13: "មេរៀនទី១៣", book3_l14: "មេរៀនទី១៤",
                book3_e1: "លំហាត់ទី១", book3_e2: "លំហាត់ទី២", book3_e3: "លំហាត់ទី៣",
                book3_e4: "លំហាត់ទី៤", book3_e5: "លំហាត់ទី៥", book3_e6: "លំហាត់ទី៦",
                book3_e7: "លំហាត់ទី៧", book3_e8: "លំហាត់ទី៨", book3_e9: "លំហាត់ទី៩",
                book3_e10: "លំហាត់ទី១០", book3_e11: "លំហាត់ទី១១", book3_e12: "លំហាត់ទី១២",
                book3_e13: "លំហាត់ទី១៣", book3_e14: "លំហាត់ទី១៤", book3_e15: "លំហាត់ទី១៥",
                book3_e16: "លំហាត់ទី១៦", book3_e17: "លំហាត់ទី១៧", book3_e18: "លំហាត់ទី១៨",

                // NEW: Modal Filter translations
                filter_lessons: "មេរៀន",
                filter_exercises: "លំហាត់",

                no_lessons_yet: "មិនទាន់មានឯកសារមេរៀនសម្រាប់មុខវិជ្ជានេះទេ។",
                contact_title: "ទំនាក់ទំនងមកពួកយើង",
                contact_subtitle: "យើងរីករាយនឹងឆ្លើយតបរាល់សំណួររបស់អ្នក។ សូមទំនាក់ទំនងតាមរយៈបណ្តាញខាងក្រោម៖",
                contact_form_title: "ផ្ញើសារ",
                contact_show_form_btn: "ចុចទីនេះដើម្បីផ្ញើសារ",
                contact_form_name: "ឈ្មោះ",
                contact_form_email: "អ៊ីមែល",
                contact_form_message: "សារ",
                contact_form_submit: "ផ្ញើសារ",
                contact_form_cancel: "បោះបង់",
                footer_text: "ចាប់ផ្តើមដំណើររបស់អ្នកក្នុងវិស័យវិស្វកម្មមេកានិកនៅថ្ងៃនេះ ហើយរួមចំណែកបង្កើតបច្ចេកវិទ្យាថ្មីៗ។",
                footer_copyright: "រក្សាសិទ្ធិគ្រប់យ៉ាង © 2025 | បង្កើតដោយ ខៀវ សំណាង",
                // Filter and Search translations
                level_all: "ទាំងអស់",
                level_associate: "បរិញ្ញាបត្ររង",
                level_bachelor: "បរិញ្ញាបត្រ",
                level_c1: "C1",
                level_c2: "C2",
                level_c3: "C3",
                filter_by_level: "តម្រងតាមកម្រិត",
                search_lessons: "ស្វែងរកមេរៀន",
                // MODIFIED: Changed placeholder text to "ស្វែងរកមេរៀន..."
                search_placeholder: "ស្វែងរកមេរៀន...", 
                no_results: "រកមិនឃើញមេរៀនដែលត្រូវនឹងតម្រងរបស់អ្នកទេ។",
                // NEW: Temporary message translation
                lessons_coming_soon: "ឯកសារមេរៀននឹងមានក្នុងពេលឆាប់ៗនេះ។ សូមអរគុណ!"
            },
            en: {
                page_title: "Lesson Library - Mechanical Engineering",
                brand_name: "Mechanical Engineer",
                nav_home: "Home",
                nav_specializations: "Specializations",
                nav_education: "Education",
                nav_book: "Book",
                nav_register: "Application Form",
                nav_gallery: "Gallery",
                nav_theme_toggle: "Toggle Theme",
                lang_km: "Khmer",
                lang_en: "English",
                book_title: "Lesson Document Library",
                book_subtitle: "Find and download PDF lesson documents for Mechanical Engineering.",
                // MODIFIED: Renamed "Mechanical Fundamentals" to "Core Capability"
                book1_title: "Core Capability",
                book1_desc: "Introduction to the core principles of mechanical engineering, equilibrium, and forces.",
                // MODIFICATION: Changed book 2 title and desc
                book2_title: "Level 1 Lessons (C1)",
                book2_desc: "Lessons for C1 level, includes the first 4 modules of Core Capability.",
                book3_title: "3D Design (SolidWorks)",
                book3_desc: "Learn 3D modeling, assembly, and Stress Analysis with SolidWorks.",
                book4_title: "CNC Technology",
                book4_desc: "Lessons on G-Code, M-Code, and operating CNC lathes and mills.",
                book5_title: "Hydraulics & Pneumatics",
                book5_desc: "Study of components and design of Hydraulic and Pneumatic control systems.",
                book6_title: "Arduino Systems",
                book6_desc: "Lessons on coding and controlling electronic components.",
                // NEW: Added Basic Competency Book (Book 7)
                book7_title: "Basic Competency",
                book7_desc: "Core subject for Associate degree focusing on foundational mechanical skills.",
                // NEW: Added Book 8 and 9
                book8_title: "Level 2 Lessons (C2)",
                book8_desc: "Lessons for C2 level.",
                book9_title: "Level 3 Lessons (C3)",
                book9_desc: "Lessons for C3 level.",
                book_view_btn: "View Lessons",
                book_read_btn: "Read",
                book_download_btn: "Download",
                // MODIFIED: Added Module translations (1-11)
                module_1: "Module 1",
                module_2: "Module 2",
                module_3: "Module 3",
                module_4: "Module 4",
                module_5: "Module 5",
                module_6: "Module 6",
                module_7: "Module 7",
                module_8: "Module 8",
                module_9: "Module 9",
                module_10: "Module 10",
                module_11: "Module 11",

                // NEW C1, C2, C3 MODULES (Corrected Comment Syntax + Keys)
                c1_mod_1: "Subject: Assembly",
                c1_mod_2: "Subject: Soft Skills",
                c1_mod_3: "Subject: Metal Tempering Level 1",
                c1_mod_4: "Subject: Metal Tempering Level 2",
                c2_mod_1: "Subject: Metal Tempering Level 3",
                c3_mod_1: "Subject: Metal Tempering Level 4",

                // NEW: CNC (Book 4) Modules
                book4_mod_1: "CNC Training Notes",
                book4_mod_2: "Commissioning Guide",
                book4_mod_3: "Operating and Programming Milling",
                book4_mod_4: "Operating and Programming Turning",

                // NEW: Arduino (Book 6) Modules
                book6_mod_1: "Microcontroller_Programming_Arduino_UNO",
                book6_mod_2: "ElEctric_Motors_Control_SyStemS_Electric",
                book6_mod_3: "Programmable_Logic_Controllers",
                book6_mod_4: "PCB-design-cource-I",
                book6_mod_5: "PCB-design-cource-II",

                // NEW: Hydraulics (Book 5) Modules
                book5_mod_1: "Fundamentals of Hydraulic Systems",
                book5_mod_2: "Pneumatic Component Symbols",
                book5_mod_3: "Pneumatic System Schemas",
                book5_mod_4: "Basic Hydraulics",
                book5_mod_5: "Basic Pneumatic System",
                book5_mod_6: "Basic Electrohydraulic Component Symbols",
                book5_mod_7: "Electrical Pneumatic System Circuit",
                book5_mod_8: "Fluid Power Formulas",
                book5_mod_9: "Hydraulic System CBLM",
                book5_mod_10: "Pneumatic System",
                book5_mod_11: "POR Pneumatic Valves",
                book5_mod_12: "Pneumatic-Hydraulic for ETEK",
                book5_mod_13: "Pneumatic-Hydraulic Practice",
                book5_mod_14: "Practical Hydraulics system",
                book5_mod_15: "Symbol use in Hydraulic",

                // NEW: SolidWorks (Book 3) Modules
                book3_lessons_title: "Lessons",
                book3_exercises_title: "Exercises",
                book3_l1: "Lesson 1", book3_l2: "Lesson 2", book3_l3: "Lesson 3",
                book3_l4: "Lesson 4", book3_l5: "Lesson 5", book3_l6: "Lesson 6",
                book3_l7: "Lesson 7", book3_l8: "Lesson 8", book3_l9: "Lesson 9",
                book3_l10: "Lesson 10", book3_l11: "Lesson 11", book3_l12: "Lesson 12",
                book3_l13: "Lesson 13", book3_l14: "Lesson 14",
                book3_e1: "Exercise 1", book3_e2: "Exercise 2", book3_e3: "Exercise 3",
                book3_e4: "Exercise 4", book3_e5: "Exercise 5", book3_e6: "Exercise 6",
                book3_e7: "Exercise 7", book3_e8: "Exercise 8", book3_e9: "Exercise 9",
                book3_e10: "Exercise 10", book3_e11: "Exercise 11", book3_e12: "Exercise 12",
                book3_e13: "Exercise 13", book3_e14: "Exercise 14", book3_e15: "Exercise 15",
                book3_e16: "Exercise 16", book3_e17: "Exercise 17", book3_e18: "Exercise 18",

                // NEW: Modal Filter translations
                filter_lessons: "Lessons",
                filter_exercises: "Exercises",

                no_lessons_yet: "No lesson documents are available for this subject yet.",
                contact_title: "Contact Us",
                contact_subtitle: "We are happy to answer your questions. Please contact us through the channels below:",
                contact_form_title: "Send Message",
                contact_show_form_btn: "Click here to send a message",
                contact_form_name: "Name",
                contact_form_email: "Email",
                contact_form_message: "Message",
                contact_form_submit: "Send Message",
                contact_form_cancel: "Cancel",
                footer_text: "Start your journey in mechanical engineering today and contribute to creating new technologies.",
                footer_copyright: "All rights reserved © 2025 | Built By Khiev Samnang",
                 // Filter and Search translations
                level_all: "All",
                level_associate: "Associate",
                level_bachelor: "Bachelor",
                level_c1: "C1",
                level_c2: "C2",
                level_c3: "C3",
                filter_by_level: "Filter by Level",
                search_lessons: "Search Lessons",
                // MODIFIED: Changed placeholder text for consistency
                search_placeholder: "Search Lessons...",
                no_results: "No lessons found matching your filters.",
                // NEW: Temporary message translation
                lessons_coming_soon: "Lesson documents will be available soon. Thank you!"
            }
        };

        const mobileMenu = document.getElementById('mobile-menu');

        // Data structure for modal links
        const subjectLinks = {
            // MODIFICATION: Added modules 1-4 back
            'book1': { titleKey: 'book1_title', links: [
                { textKey: 'module_1', path: 'PDF/BT1-2/Module_1_Performing_technical_drawings_and_inspection.pdf' }, 
                { textKey: 'module_2', path: 'PDF/BT1-2/Module 2- Performing lathe operation_khmer.pdf' }, 
                { textKey: 'module_3', path: 'PDF/BT1-2/Module 3- Performing milling operation_Khmer.pdf' },
                { textKey: 'module_4', path: 'PDF/BT1-2/Module 4- Performing grinding operation_Khmer.pdf' },
                { textKey: 'module_5', path: 'PDF/BT1-2/Module_5_Performing_CNC_lathe_programming_and_operation.pdf' },
                { textKey: 'module_6', path: 'PDF/BT1-2/Module_6_Performing_CNC_milling_programming_and_operation.pdf' },
                { textKey: 'module_7', path: 'PDF/BT1-2/Module 7- 3D CAD-CAM application_Khmer.pdf' }
            ]},
            // NEW: Book 7 (Basic Competency) with 11 modules for Associate Degree
            'book7': { titleKey: 'book7_title', links: [
                { textKey: 'module_1', path: 'PDF/BY1-2/Level 5-Module 1 Supervise application of key communication skills_Khmer.pdf' },
                { textKey: 'module_2', path: 'PDF/BY1-2/Level 5-Module 2 Supervise Development of Team and Individuals-Khmer.pdf' },
                { textKey: 'module_3', path: 'PDF/BY1-2/Level 5-Module 3 Supervise problem solving techniques in the workplace-Khmer.pdf' },
                { textKey: 'module_4', path: 'PDF/BY1-2/Level 5-Module 4 Supervise data collection and analysis in the workplace-Khmer.pdf' },
                { textKey: 'module_5', path: 'PDF/BY1-2/Level 5-Module 5 Plan and organize work for several work teams-Khmer.pdf' },
                { textKey: 'module_6', path: 'PDF/BY1-2/Level 5-Module 6 Supervise environmental protection implementation-Khmer.pdf' },
                { textKey: 'module_7', path: 'PDF/BY1-2/Level 5-Module 7 Supervise OHS work issues in the construction industry-Khmer.pdf' },
                { textKey: 'module_8', path: 'PDF/BY1-2/Level 5-Module 8 Apply gender and social equity principles and policies-Khmer.pdf' },
                { textKey: 'module_9', path: 'PDF/BY1-2/Level 5-Module 9 Supervise compliance with procedures specifications-Khmer.pdf' },
                { textKey: 'module_10', path: 'PDF/BY1-2/Level 5-Module 10 Supervise preparation use and maintenance of tools and equipment-Khmer.pdf' },
                { textKey: 'module_11', path: 'PDF/BY1-2/Level 5-Module 11 Supervise Interpretation of Technical Drawings- Plans and Mathematic Calculations-Khmer.pdf' }
            ]},
            // MODIFICATION: Changed book 2 links to new C1 modules
            'book2': { titleKey: 'book2_title', links: [
                { textKey: 'c1_mod_1', path: 'PDF/C1 to C3/ប្រមុំ.pdf' }, 
                { textKey: 'c1_mod_2', path: 'PDF/C1 to C3/ជំនាញទន់.pdf' }, 
                { textKey: 'c1_mod_3', path: 'PDF/C1 to C3/ការបន្សីលោហៈ_សមត្ថភាពស្នូល 1.pdf' },
                { textKey: 'c1_mod_4', path: 'PDF/C1 to C3/ឧបសម្ព័ន្ធទី២០CSការបន្ស៉ីលោហៈ_កម្រិត២.pdf' }
            ]},
            // MODIFICATION: Add sections and links to book3, and add downloadDisabled
            'book3': {
                titleKey: 'book3_title',
                downloadDisabled: true, // <-- ADD THIS
                sections: [
                    {
                        type: 'lessons', // <-- ADD THIS
                        titleKey: 'book3_lessons_title',
                        links: [
                            { textKey: 'book3_l1', path: 'PDF/SolidWork/TOPIC 1-INTRODUCTION TO SOLIDWORKS CAM STANDARD- MILLING.pdf' },
                            { textKey: 'book3_l2', path: 'PDF/SolidWork/TOPIC_2_AUTOMATIC_FEATURE_RECOGNITION_SETUP_1_DEFINING_MACHINE.pdf' },
                            { textKey: 'book3_l3', path: 'PDF/SolidWork/TOPIC_3_AUTOMATIC_FEATURE_RECOGNITION_SETUP_2_DEFINING_STOCK.pdf' },
                            { textKey: 'book3_l4', path: 'PDF/SolidWork/TOPIC_4_AUTOMATIC_FEATURE_RECOGNITION_SETUP_3_DEFINING_COORDINATE.pdf' },
                            { textKey: 'book3_l5', path: 'PDF/SolidWork/TOPIC_5_AUTOMATIC_FEATURE_RECOGNITION_SET_UP_4_EXTRACT_MACHINABE.pdf' },
                            { textKey: 'book3_l6', path: 'PDF/SolidWork/TOPIC_6_AUTOMATIC_FEATURE_RECOGNITION_SETUP_5_GENERATE_OPERATION.pdf' },
                            { textKey: 'book3_l7', path: 'PDF/SolidWork/TOPIC_7_AUTOMATIC_FEATURE_RECOGNITION_SETUP_6_SORTING_OPERATION.pdf' },
                            { textKey: 'book3_l8', path: 'PDF/SolidWork/TOPIC_8_AUTOMATIC_FEATURE_RECOGNITION_SETUP_7_GENERATING_TOOLPATHS.pdf' },
                            { textKey: 'book3_l9', path: 'PDF/SolidWork/TOPIC_9_AUTOMATIC_FEATURE_RECOGNITION_SETUP_8_SIMULATE_TOOLPATHS.pdf' },
                            { textKey: 'book3_l10', path: 'PDF/SolidWork/TOPIC_10_AUTOMATIC_FEATURE_RECOGNITION_SETUP_9_POST_PROCESSING_NC.pdf' },
                            { textKey: 'book3_l11', path: 'PDF/SolidWork/TOPIC 11-INTRODUCTION TO INTERACTIVE FEATURE RECOGNITION.pdf' },
                            { textKey: 'book3_l12', path: 'PDF/SolidWork/TOPIC 12-HOW TO CUSTOMIZE NEW MACHINE.pdf' },
                            { textKey: 'book3_l13', path: 'PDF/SolidWork/TOPIC 13-HOW TO  CUSTOMIZE TOOL CRIB.pdf' },
                            { textKey: 'book3_l14', path: 'PDF/SolidWork/10.0_SOLIDWORKS CAD TUTORIAL.pdf' }
                        ]
                    },
                    {
                        type: 'exercises', // <-- ADD THIS
                        titleKey: 'book3_exercises_title',
                        links: [
                            { textKey: 'book3_e1', path: 'PDF/Solidwork/Exercises/E1.pdf' },
                            { textKey: 'book3_e2', path: 'PDF/Solidwork/Exercises/E2.pdf' },
                            { textKey: 'book3_e3', path: 'PDF/Solidwork/Exercises/E3.pdf' },
                            { textKey: 'book3_e4', path: 'PDF/Solidwork/Exercises/E4.pdf' },
                            { textKey: 'book3_e5', path: 'PDF/Solidwork/Exercises/E5.pdf' },
                            { textKey: 'book3_e6', path: 'PDF/Solidwork/Exercises/E6.pdf' },
                            { textKey: 'book3_e7', path: 'PDF/Solidwork/Exercises/E7.pdf' },
                            { textKey: 'book3_e8', path: 'PDF/Solidwork/Exercises/E8.pdf' },
                            { textKey: 'book3_e9', path: 'PDF/Solidwork/Exercises/E9.pdf' },
                            { textKey: 'book3_e10', path: 'PDF/Solidwork/Exercises/E10.pdf' },
                            { textKey: 'book3_e11', path: 'PDF/Solidwork/Exercises/E11.pdf' },
                            { textKey: 'book3_e12', path: 'PDF/Solidwork/Exercises/E12.pdf' },
                            { textKey: 'book3_e13', path: 'PDF/Solidwork/Exercises/E13.pdf' },
                            { textKey: 'book3_e14', path: 'PDF/Solidwork/Exercises/E14.pdf' },
                            { textKey: 'book3_e15', path: 'PDF/Solidwork/Exercises/E15.pdf' },
                            { textKey: 'book3_e16', path: 'PDF/Solidwork/Exercises/E16.pdf' },
                            { textKey: 'book3_e17', path: 'PDF/Solidwork/Exercises/E17.pdf' },
                            { textKey: 'book3_e18', path: 'PDF/Solidwork/Exercises/E18.pdf' }
                        ]
                    }
                ]
            },
            // MODIFICATION: Added 4 modules to book4 AND disabled download
            'book4': { 
                titleKey: 'book4_title', 
                links: [
                    { textKey: 'book4_mod_1', path: 'PDF/CNC/CNC_Training Notes.pdf' },
                    { textKey: 'book4_mod_2', path: 'PDF/CNC/Commissioning_Guide.pdf' },
                    { textKey: 'book4_mod_3', path: 'PDF/CNC/Operating_and_Programming_Milling.pdf' },
                    { textKey: 'book4_mod_4', path: 'PDF/CNC/Operating_and_Programming_Turning.pdf' }
                ],
                downloadDisabled: true // Flag to disable download
            },
            // MODIFICATION: Add 15 modules to book5 and set downloadDisabled to true
            'book5': { 
                titleKey: 'book5_title', 
                links: [
                    { textKey: 'book5_mod_1', path: 'PDF/Hydraulics/មូលដ្ឋានគ្រឹះ_ប្រពន្ធ័ហាយដ្រូលិក.pdf' },
                    { textKey: 'book5_mod_2', path: 'PDF/Hydraulics/និសញ្ញាគ្រឿងបង្គុំប្រពន្ធ័ខ្យល់.pdf' },
                    { textKey: 'book5_mod_3', path: 'PDF/Hydraulics/សេម៉ាប្រពន្ធ័ខ្យល់.pdf' },
                    { textKey: 'book5_mod_4', path: 'PDF/Hydraulics/Basic Hydraulics.pdf' },
                    { textKey: 'book5_mod_5', path: 'PDF/Hydraulics/Basic Pneumatic System.pdf' },
                    { textKey: 'book5_mod_6', path: 'PDF/Hydraulics/Basic_Electrohydraulic_Component_Symbols.pdf' },
                    { textKey: 'book5_mod_7', path: 'PDF/Hydraulics/Electrical Pneumatic System Circuit.pdf' },
                    { textKey: 'book5_mod_8', path: 'PDF/Hydraulics/Fluid-Power-Formulas.pdf' },
                    { textKey: 'book5_mod_9', path: 'PDF/Hydraulics/Hydraulic System CBLM.pdf' },
                    { textKey: 'book5_mod_10', path: 'PDF/Hydraulics/Pneumatic System.pdf' },
                    { textKey: 'book5_mod_11', path: 'PDF/Hydraulics/Pneumatic Valves.pdf' },
                    { textKey: 'book5_mod_12', path: 'PDF/Hydraulics/Pneumatic-Hydraulic for ETEK.pdf' },
                    { textKey: 'book5_mod_13', path: 'PDF/Hydraulics/Pneumatic-Hydraulic Practice.pdf' },
                    { textKey: 'book5_mod_14', path: 'PDF/Hydraulics/Practical Hydraulics system.pdf' },
                    { textKey: 'book5_mod_15', path: 'PDF/Hydraulics/Symbol use in Hydraulic.pdf' }
                ],
                downloadDisabled: true // Flag to disable download
            },
            // MODIFICATION: Added 5 modules to book6 and set downloadDisabled to true
            'book6': { 
                titleKey: 'book6_title', 
                links: [
                    { textKey: 'book6_mod_1', path: 'PDF/Arduino/Microcontroller_Programming_Arduino_UNO.pdf' },
                    { textKey: 'book6_mod_2', path: 'PDF/Arduino/ElEctric_Motors_Control_SyStemS_Electric.pdf' },
                    { textKey: 'book6_mod_3', path: 'PDF/Arduino/Programmable_Logic_Controllers.pdf' },
                    { textKey: 'book6_mod_4', path: 'PDF/Arduino/PCB-design-cource-I.pdf' },
                    { textKey: 'book6_mod_5', path: 'PDF/Arduino/PCB-design-cource-II.pdf' }
                ],
                downloadDisabled: true // Flag to disable download
            },
            // NEW: Added Book 8 and 9 links (using a placeholder PDF for now)
            // MODIFICATION: Changed book 8 link to new C2 module
            'book8': { titleKey: 'book8_title', links: [
                { textKey: 'c2_mod_1', path: 'PDF/C1 to C3/ឧបសម្ព័ន្ធទី២០CSការបន្ស៉ីលោហៈ_កម្រិត៣.pdf' }
            ]},
            // MODIFICATION: Changed book 9 link to new C3 module
            'book9': { titleKey: 'book9_title', links: [
                { textKey: 'c3_mod_1', path: 'PDF/C1 to C3/ឧបសម្ព័ន្ធទី២០CSការបន្ស៉ីលោហៈ_កម្រិត៤.pdf' }
            ]}
        };

        // Modal Functions
        // MODIFICATION: Reworked openModal and added renderModalContent
        function openModal(subjectKey) {
            const modal = document.getElementById('pdfModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalLinks = document.getElementById('modalLinks');
            const filterBar = document.getElementById('modalFilterBar'); // Get filter bar
            
            if (!modal || !modalTitle || !modalLinks || !filterBar || !subjectLinks[subjectKey]) {
                console.error('Modal elements or subject data not found for:', subjectKey);
                return;
            }

            modalLinks.innerHTML = ''; // Clear old links
            const data = subjectLinks[subjectKey];
            modalTitle.textContent = getTranslation(data.titleKey);

            // NEW: Check for sections (like in book3)
            if (data.sections && data.sections.length > 0) {
                filterBar.classList.remove('hidden');
                
                // Set click listeners for filter buttons
                const lessonsBtn = document.getElementById('modal-filter-lessons');
                const exercisesBtn = document.getElementById('modal-filter-exercises');

                if(lessonsBtn) lessonsBtn.onclick = () => renderModalContent(subjectKey, 'lessons');
                if(exercisesBtn) exercisesBtn.onclick = () => renderModalContent(subjectKey, 'exercises');

                // Render the default view (lessons)
                renderModalContent(subjectKey, 'lessons');
            } 
            // Handle simple books (like book1, book2, etc.)
            else {
                filterBar.classList.add('hidden'); // Hide filter bar
                renderModalContent(subjectKey, 'all'); // 'all' signifies rendering simple links
            }
            
            modal.classList.remove('hidden');
        }

        // NEW: Function to render content inside modal (handles filtering)
        function renderModalContent(subjectKey, filterType) {
            const modalLinks = document.getElementById('modalLinks');
            if (!modalLinks) return;
            
            modalLinks.innerHTML = ''; // Clear current links
            const data = subjectLinks[subjectKey];

            // Update active state for filter buttons
            const lessonsBtn = document.getElementById('modal-filter-lessons');
            const exercisesBtn = document.getElementById('modal-filter-exercises');
            if (lessonsBtn && exercisesBtn) {
                lessonsBtn.classList.toggle('active', filterType === 'lessons');
                exercisesBtn.classList.toggle('active', filterType === 'exercises');
            }

            let linksToRender = [];
            
            if (filterType === 'all') { // For simple books
                linksToRender = data.links || [];
            } else if (data.sections) { // For sectioned books (like book3)
                const section = data.sections.find(s => s.type === filterType);
                if (section) {
                    linksToRender = section.links || [];
                }
            }

            // Render the links
            if (linksToRender.length > 0) {
                linksToRender.forEach(link => {
                    const lessonDiv = document.createElement('div');
                    lessonDiv.className = 'flex flex-col sm:flex-row items-center justify-between bg-gray-100 dark:bg-gray-700 p-4 rounded-lg';
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'text-gray-800 dark:text-gray-200 font-medium mb-3 sm:mb-0 text-center sm:text-left w-full sm:w-auto';
                    titleSpan.textContent = getTranslation(link.textKey);
                    const buttonGroup = document.createElement('div');
                    buttonGroup.className = 'flex space-x-2 flex-shrink-0 mt-2 sm:mt-0';
                    
                    const readButton = document.createElement('a');
                    readButton.href = link.path;
                    readButton.target = '_blank';
                    readButton.rel = 'noopener noreferrer';
                    readButton.className = 'px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 transition duration-300 inline-flex items-center';
                    readButton.innerHTML = `<i class="fas fa-book-reader fa-fw mr-1.5"></i> <span>${getTranslation('book_read_btn')}</span>`;
                    buttonGroup.appendChild(readButton);

                    // Check for downloadDisabled flag on the parent book object
                    if (!data.downloadDisabled) {
                        const downloadButton = document.createElement('a');
                        downloadButton.href = link.path;
                        downloadButton.download = link.path.split('/').pop();
                        downloadButton.className = 'px-3 py-1 bg-green-600 text-white text-sm font-semibold rounded-md hover:bg-green-700 transition duration-300 inline-flex items-center';
                        downloadButton.innerHTML = `<i class="fas fa-download fa-fw mr-1.5"></i> <span>${getTranslation('book_download_btn')}</span>`;
                        buttonGroup.appendChild(downloadButton);
                    }
                    
                    lessonDiv.appendChild(titleSpan);
                    lessonDiv.appendChild(buttonGroup);
                    modalLinks.appendChild(lessonDiv);
                });
            } else {
                // No links found for this filter or book
                modalLinks.innerHTML = `<p class="text-gray-600 dark:text-gray-400">${getTranslation('no_lessons_yet')}</p>`;
            }
        }


        function closeModal() {
            const modal = document.getElementById('pdfModal');
            if (modal) modal.classList.add('hidden');
        }

        // Email Sending (Mailto)
        function sendEmail() {
            try {
                const name = document.getElementById('contactName').value;
                const email = document.getElementById('contactEmail').value;
                const message = document.getElementById('contactMessage').value;
                const subject = `Message from Website by ${name}`;
                const body = `Message:\n${message}\n\nFrom: ${name}\nEmail: ${email}`;
                const recipientEmail = 'ratana.lyon2uni@gmail.com';
                if (!name || !email || !message) {
                    showCustomMessage(getTranslation('validation_fill_all') || 'Please fill in all fields.');
                    return;
                }
                window.location.href = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            } catch (error) {
                console.error("Error sending email:", error);
                showCustomMessage('Could not open email client. Please copy the address: ' + recipientEmail);
            }
        }

        // Custom Message Box
        function showCustomMessage(message, type = 'error') {
            let existingBox = document.getElementById('customMessageBox');
            if (existingBox) existingBox.remove();
            const messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            const bgColor = type === 'success' ? '#10B981' : '#EF4444';
            messageBox.style = `position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: ${bgColor}; color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; font-family: 'Kantumruy Pro', sans-serif; max-width: 90%; text-align: center;`;
            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style = "margin: 0; margin-right: 20px;";
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style = "position: absolute; top: 5px; right: 10px; background: none; border: none; color: white; font-size: 20px; cursor: pointer;";
            closeButton.onclick = () => messageBox.remove();
            messageBox.appendChild(messageText);
            messageBox.appendChild(closeButton);
            document.body.appendChild(messageBox);
            setTimeout(() => { if (document.getElementById('customMessageBox')) messageBox.remove(); }, 5000);
        }

        // Contact Form Toggle
        function toggleContactForm() {
            try {
                const form = document.getElementById('contactForm');
                const button = document.getElementById('showContactFormBtn');
                if (form) form.classList.remove('hidden');
                if (button) button.classList.add('hidden');
            } catch (error) { console.error("Error showing contact form:", error); }
        }

        function closeContactForm() {
            try {
                const form = document.getElementById('contactForm');
                const button = document.getElementById('showContactFormBtn');
                if (form) { form.classList.add('hidden'); form.reset(); }
                if (button) button.classList.remove('hidden');
            } catch (error) { console.error("Error closing contact form:", error); }
        }

        // Theme Switching
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const htmlEl = document.documentElement;

        function updateTheme(isDark) {
            if (!htmlEl) { console.error("<html> element not found."); return; }
            htmlEl.classList.toggle('dark', isDark);
            if (themeIcon) {
                themeIcon.classList.toggle('fa-sun', !isDark);
                themeIcon.classList.toggle('fa-moon', isDark);
            } else { console.warn("Desktop theme icon element not found."); }
            try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
            catch (error) { console.error("Could not save theme to localStorage:", error); }
        }

        function toggleDarkMode() {
            if (!htmlEl) { console.error("Cannot toggle dark mode: <html> element not found."); return; }
            updateTheme(!htmlEl.classList.contains('dark'));
        }

        // Language Switching
        const currentLangFlag = document.getElementById('current-lang-flag');
        const flagSources = { km: 'https://flagcdn.com/kh.svg', en: 'https://flagcdn.com/gb.svg' };

        function getTranslation(key, langOverride = null) {
            try {
                const currentLang = langOverride || localStorage.getItem('preferredLanguage') || 'km';
                return translations[currentLang]?.[key] || (currentLang === 'km' ? translations['en']?.[key] : null) || key;
            } catch (e) { console.error("Error getting translation for key:", key, e); return key; }
        }

        function setLanguage(lang) {
            if (!translations[lang]) { console.error(`Translations for language "${lang}" not found.`); return; }
            try { localStorage.setItem('preferredLanguage', lang); }
            catch (error) { console.error("Could not save language preference to localStorage:", error); }
            if (htmlEl) htmlEl.lang = lang; else console.error("<html> element not found.");
            if (currentLangFlag) currentLangFlag.src = flagSources[lang];

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                 // Check if the element is an input placeholder
                 if (el.tagName === 'INPUT' && el.hasAttribute('placeholder') && key === 'search_placeholder') {
                      el.placeholder = getTranslation(key, lang);
                 } else {
                     const translatedText = getTranslation(key, lang);
                    if (translatedText !== key || lang === 'en') {
                        if (key.includes('_list') || key.includes('_details')) { el.innerHTML = translatedText; }
                        else if (el.tagName === 'OPTION') { el.textContent = translatedText; }
                        else if (el.tagName === 'INPUT' && el.type === 'submit') { el.value = translatedText; }
                        else if (el.tagName === 'TITLE') { el.textContent = translatedText; }
                        else {
                            let textUpdated = false;
                            for (let node of el.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0) { node.textContent = translatedText; textUpdated = true; break; }
                                else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SPAN' && !node.hasAttribute('data-translate-key')) {
                                    if (node.childNodes.length === 1 && node.firstChild.nodeType === Node.TEXT_NODE) { node.firstChild.textContent = translatedText; textUpdated = true; break; }
                                }
                            }
                            if (!textUpdated && !el.querySelector('i') && !el.querySelector('img') && !el.hasAttribute('placeholder')) { // Avoid overwriting placeholder again
                                 el.textContent = translatedText;
                            }
                        }
                    }
                 }
            });

            if (mobileMenu) mobileMenu.classList.add('hidden');
            const langOptionsEl = document.getElementById('lang-options');
            if (langOptionsEl) langOptionsEl.classList.add('hidden');
        }

        // Language Dropdown Logic
        const langSwitcherBtn = document.getElementById('lang-switcher-btn');
        const langOptions = document.getElementById('lang-options');
        if (langSwitcherBtn && langOptions) {
            langSwitcherBtn.addEventListener('click', (e) => { e.stopPropagation(); langOptions.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => {
                const container = document.getElementById('lang-switcher-container');
                if (container && !container.contains(e.target)) langOptions.classList.add('hidden');
            });
        } else { console.warn("Language switcher button or options element not found."); }

        // Mobile Menu Toggle
        const menuBtn = document.getElementById('menu-btn');
        if (menuBtn) {
            menuBtn.addEventListener('click', () => {
                const mobileMenuEl = document.getElementById('mobile-menu');
                if (mobileMenuEl) mobileMenuEl.classList.toggle('hidden'); else console.error("Mobile menu element not found on click.");
            });
            const mobileMenuEl = document.getElementById('mobile-menu');
            if (mobileMenuEl) {
                mobileMenuEl.querySelectorAll('a').forEach(link => {
                    if (!link.onclick || (link.onclick && !link.onclick.toString().includes("setLanguage"))) {
                        link.addEventListener('click', () => mobileMenuEl.classList.add('hidden'));
                    }
                });
            }
        } else { console.warn("Mobile menu button not found."); }

        // --- MODIFIED: Combined Book Filtering and Searching Logic ---
        function applyFilters() {
            const levelFilter = document.getElementById('level-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const books = document.querySelectorAll('.book-item');
            const noResultsMessage = document.getElementById('no-results-message');
            let resultsFound = false;

            // Helper function to get module text for a book
            function getModuleSearchText(bookElement) {
                try {
                    const button = bookElement.querySelector('button[onclick]');
                    const onclickAttr = button.getAttribute('onclick');
                    // Extracts 'book1' from "openModal('book1')"
                    const bookKey = onclickAttr.match(/openModal\('([^']+)'\)/)[1];
                    
                    if (bookKey && subjectLinks[bookKey]) {
                        let textKm = '';
                        let textEn = '';
                        
                        // Handle new 'sections' structure
                        if (subjectLinks[bookKey].sections) {
                            subjectLinks[bookKey].sections.forEach(section => {
                                const moduleKeys = section.links.map(link => link.textKey);
                                textKm += moduleKeys.map(key => getTranslation(key, 'km').toLowerCase()).join(' ') + ' ';
                                textEn += moduleKeys.map(key => getTranslation(key, 'en').toLowerCase()).join(' ') + ' ';
                            });
                        } 
                        // Handle old 'links' structure
                        else if (subjectLinks[bookKey].links) {
                            const moduleKeys = subjectLinks[bookKey].links.map(link => link.textKey);
                            textKm = moduleKeys.map(key => getTranslation(key, 'km').toLowerCase()).join(' ');
                            textEn = moduleKeys.map(key => getTranslation(key, 'en').toLowerCase()).join(' ');
                        }
                        return textKm + ' ' + textEn;
                    }
                } catch (e) {
                    // console.warn("Could not parse module text for search:", bookElement, e);
                }
                return '';
            }

            books.forEach(book => {
                const bookLevels = book.dataset.level || '';
                const titleElement = book.querySelector('.book-title');
                const descElement = book.querySelector('.book-desc');

                // Get original text content or translation key for searching
                const titleKey = titleElement ? titleElement.getAttribute('data-translate-key') : '';
                const descKey = descElement ? descElement.getAttribute('data-translate-key') : '';

                // Get text in both languages for searching
                 const titleKm = getTranslation(titleKey, 'km').toLowerCase();
                 const descKm = getTranslation(descKey, 'km').toLowerCase();
                 const titleEn = getTranslation(titleKey, 'en').toLowerCase();
                 const descEn = getTranslation(descKey, 'en').toLowerCase();
                 
                 // NEW: Get module text
                 const moduleText = getModuleSearchText(book);

                const levelMatch = (levelFilter === 'all' || bookLevels.includes(levelFilter));
                 // Check if search term matches title, description, OR module text
                 const searchMatch = (
                     titleKm.includes(searchTerm) ||
                     descKm.includes(searchTerm) ||
                     titleEn.includes(searchTerm) ||
                     descEn.includes(searchTerm) ||
                     moduleText.includes(searchTerm) // NEW condition
                 );

                if (levelMatch && searchMatch) {
                    book.classList.add('flex');
                    book.classList.remove('hidden');
                    resultsFound = true;
                } else {
                    book.classList.remove('flex');
                    book.classList.add('hidden');
                }
            });

             // Show or hide the "no results" message
             if (noResultsMessage) {
                 if (resultsFound) {
                     noResultsMessage.classList.add('hidden');
                 } else {
                     noResultsMessage.classList.remove('hidden');
                 }
             }
        }


        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Theme
            try {
                const savedTheme = localStorage.getItem('theme');
                updateTheme(savedTheme === 'dark');
            } catch (error) { console.error("Error initializing theme:", error); updateTheme(false); }
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleDarkMode); else console.error("Theme toggle button not found after DOM load!");

            // Initialize Language
            try {
                const preferredLanguage = localStorage.getItem('preferredLanguage') || 'km';
                setLanguage(preferredLanguage);
            } catch (error) { console.error("Error initializing language:", error); }

            // Apply initial filters (show all, empty search)
            applyFilters(); 
        });

    </script>
</body>
</html>
